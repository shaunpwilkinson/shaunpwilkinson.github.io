<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme" content="hugo-academic">
  <meta name="generator" content="Hugo 0.40.1" />
  <meta name="author" content="Shaun Wilkinson">
  <meta name="description" content="Principal Scientist - Wilderlab NZ LTD">

  
  
  
    
  
  
    
    
    <link rel="stylesheet" href="/css/highlight.min.css">
    
  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha512-6MXa8B6uaO18Hid6blRMetEIoPqHf7Ux1tnyIQdpt9qI5OACx7C+O3IVTr98vwGnlcg0LOLa02i9Y1HpVhlfiw==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.0/css/academicons.min.css" integrity="sha512-GGGNUPDhnG8LEAEDsjqYIQns+Gu8RBs4j5XGlxl7UfRaZBhCCm5jenJkeJL8uPuOXGqgl8/H1gjlWQDRjd3cUQ==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw==" crossorigin="anonymous">
  
  
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather%7CRoboto+Mono">
  <link rel="stylesheet" href="/css/hugo-academic.css">
  

  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-131748655-1', 'auto');
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  

  <link rel="alternate" href="/index.xml" type="application/rss+xml" title="Shaun Wilkinson">
  <link rel="feed" href="/index.xml" type="application/rss+xml" title="Shaun Wilkinson">

  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/apple-touch-icon.png">

  <link rel="canonical" href="/post/insect-vignette/">

  

  <title>The &#39;insect&#39; R package and metabarcoding pipeline | Shaun Wilkinson</title>

</head>
<body id="top" data-spy="scroll" data-target="#navbar-main" data-offset="71">

<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Shaun Wilkinson</a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      <ul class="nav navbar-nav navbar-right">
        

        

        <li class="nav-item">
          <a href="/#about">
            
            <span>Home</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#publications">
            
            <span>Publications</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#cv">
            
            <span>CV</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#posts">
            
            <span>Posts</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#projects">
            
            <span>Projects</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#teaching">
            
            <span>Teaching</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#contact">
            
            <span>Contact</span>
          </a>
        </li>

        
        

        
      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  


  <div class="article-container">
    <h1 itemprop="name">The &#39;insect&#39; R package and metabarcoding pipeline</h1>
    

<div class="article-metadata">

  <span class="article-date">
    <time datetime="2019-01-01 12:00:00 &#43;0000 UTC" itemprop="datePublished">
      Tue, Jan 1, 2019
    </time>
  </span>

  

  
  
  
  <span class="article-tags">
    <i class="fa fa-tags"></i>
    
    <a href="/tags/taxonomic-classification">taxonomic classification</a
    >, 
    
    <a href="/tags/sequence-analysis">sequence analysis</a
    >
    
  </span>
  
  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=%2fpost%2finsect-vignette%2f"
         target="_blank">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=The%20%27insect%27%20R%20package%20and%20metabarcoding%20pipeline&amp;url=%2fpost%2finsect-vignette%2f"
         target="_blank">
        <i class="fa fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2fpost%2finsect-vignette%2f&amp;title=The%20%27insect%27%20R%20package%20and%20metabarcoding%20pipeline"
         target="_blank">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=%2fpost%2finsect-vignette%2f&amp;title=The%20%27insect%27%20R%20package%20and%20metabarcoding%20pipeline"
         target="_blank">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=The%20%27insect%27%20R%20package%20and%20metabarcoding%20pipeline&amp;body=%2fpost%2finsect-vignette%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>

    <div class="article-style" itemprop="articleBody">
      

<hr />

<h2 id="introduction">Introduction</h2>

<p>Welcome to the <strong>insect</strong> R package, a tool for assigning taxon IDs to
amplicon libraries using <strong>in</strong>formatic <strong>se</strong>quence <strong>c</strong>lassification
<strong>t</strong>rees. The <strong>insect</strong> learning algorithm takes a set of reference
sequences (obtained from GenBank and/or other sources) to build a
classification tree, which is then used to assign taxonomic IDs to a set
of query sequences (e.g. those generated from an NGS platform such as
Illumina MiSeq). The learning and classification functions are best
suited to computing environments with multiple processors and access to
large amounts of memory; however, most modest-sized datasets can be
processed on standard personal computers if time is available. While not
a prerequisite, <strong>insect</strong> is designed to be used in conjunction with
the <strong>ape</strong> package (Paradis <em>et al.</em>, 2004; Paradis, 2012), which
features memory-efficient binary formats for DNA and amino acid
sequences (&ldquo;DNAbin&rdquo; and &ldquo;AAbin&rdquo; object types), and the <strong>dada2</strong> package
(Callahan <em>et al.</em>, 2016) which contains essential functions for
de-noising high-throughput sequencing data and other important
pre-processing steps.</p>

<p>The <strong>insect</strong> package can be used to analyze environmental DNA (eDNA)
meta-barcode libraries as well as single-source NGS/Sanger amplicon
sequences.</p>

<p>The most time-consuming and memory-intensive stage of the <strong>insect</strong>
work-flow generally involves training the classifier. For example, the
COI classifier used in this tutorial, which was built from the <a href="http://reference-midori.info/download.php" target="_blank">MIDORI
UNIQUE</a> reference trainingset
consisting of nearly a million COI barcode sequences, took around three
days to run on a 24 x multithread. The <strong>insect</strong> classification trees
are amplicon specific, so a unique tree is generally required for each
primer set. However, trees are already available for some of the more
commonly used barcoding primers here:</p>

<!-- note newlines needed between html tags and code chunk -->

<table>
<thead>
<tr class="header">
<th align="left">Marker</th>
<th align="left">Target</th>
<th align="left">Primers</th>
<th align="left">Source</th>
<th align="right">Version</th>
<th align="right">Date</th>
<th align="left">Download</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">12S</td>
<td align="left">Fish</td>
<td align="left">MiFishUF/MiFishUR (<a href="https://www.ncbi.nlm.nih.gov/pubmed/26587265">Miya et al 2015</a>)</td>
<td align="left">GenBank</td>
<td align="right">1</td>
<td align="right">20181111</td>
<td align="left"><a href="https://www.dropbox.com/s/fv3dpvws6zjvtib/classifier.rds?dl=1">RDS (9MB)</a></td>
</tr>
<tr class="even">
<td align="left">16S</td>
<td align="left">Marine crustaceans</td>
<td align="left">Crust16S_F/Crust16S_R (<a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5528208/">Berry et al 2017</a>)</td>
<td align="left">GenBank</td>
<td align="right">4</td>
<td align="right">20180626</td>
<td align="left"><a href="https://www.dropbox.com/s/9vl9gj3frw7ng1m/classifier.rds?dl=1">RDS (7.1 MB)</a></td>
</tr>
<tr class="odd">
<td align="left">16S</td>
<td align="left">Marine fish</td>
<td align="left">Fish16sF/16s2R (<a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5528208/">Berry et al 2017</a>; <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1959119/">Deagle et al 2007</a>)</td>
<td align="left">GenBank</td>
<td align="right">4</td>
<td align="right">20180627</td>
<td align="left"><a href="https://www.dropbox.com/s/fvfrd46exdah037/classifier.rds?dl=1">RDS (6.8MB)</a></td>
</tr>
<tr class="even">
<td align="left">18S</td>
<td align="left">Marine eukaryotes</td>
<td align="left">18S_1F/18S_400R (<a href="https://www.ncbi.nlm.nih.gov/pubmed/24023913">Pochon et al 2017</a>)</td>
<td align="left">SILVA_132_LSUParc, GenBank</td>
<td align="right">5</td>
<td align="right">20180709</td>
<td align="left"><a href="https://www.dropbox.com/s/rmhh1g73jtipagu/classifier.rds?dl=1">RDS (11.8 MB)</a></td>
</tr>
<tr class="odd">
<td align="left">18S</td>
<td align="left">Marine eukaryotes</td>
<td align="left">18S_V4F/18S_V4R (<a href="https://www.ncbi.nlm.nih.gov/pubmed/28947818">Stat et al 2017</a>)</td>
<td align="left">GenBank</td>
<td align="right">4</td>
<td align="right">20180525</td>
<td align="left"><a href="https://www.dropbox.com/s/s315gxuo4p24kx8/classifier.rds?dl=1">RDS (11.5 MB)</a></td>
</tr>
<tr class="even">
<td align="left">23S</td>
<td align="left">Algae</td>
<td align="left">p23SrV_f1/p23SrV_r1 (<a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1529-8817.2007.00341.x">Sherwood &amp; Presting 2007</a>)</td>
<td align="left">SILVA_132_LSUParc</td>
<td align="right">1</td>
<td align="right">20180715</td>
<td align="left"><a href="https://www.dropbox.com/s/6o8cauqrlgnmwp5/classifier.rds?dl=1">RDS (26.9MB)</a></td>
</tr>
<tr class="odd">
<td align="left">COI</td>
<td align="left">Metazoans</td>
<td align="left">mlCOIintF/jgHCO2198 (<a href="https://frontiersinzoology.biomedcentral.com/articles/10.1186/1742-9994-10-34">Leray et al 2013</a>)</td>
<td align="left">Midori, GenBank</td>
<td align="right">5</td>
<td align="right">20181124</td>
<td align="left"><a href="https://www.dropbox.com/s/dvnrhnfmo727774/classifier.rds?dl=1">RDS (140 MB)</a></td>
</tr>
<tr class="even">
<td align="left">ITS2</td>
<td align="left">Cnidarians and sponges</td>
<td align="left">scl58SF/scl28SR (<a href="https://www.dropbox.com/s/6hcs1goju60wqi4/README.txt?dl=1">Wilkinson et al in prep</a>)</td>
<td align="left">GenBank</td>
<td align="right">5</td>
<td align="right">20180920</td>
<td align="left"><a href="https://www.dropbox.com/s/f07cka6308ebk2o/classifier.rds?dl=1">RDS (6.6 MB)</a></td>
</tr>
</tbody>
</table>

<p>The insect package also includes functions for downloading, trimming and
filtering reference datasets (including a &ldquo;virtual PCR&rdquo; tool and an
annotation quality filter), building a hierarchical taxonomy database,
and training the classifier; however, these methods are beyond the scope
of this introductory tutorial. New classification trees and updates are
frequently added to the collection, so please feel free to suggest a
barcoding primer set with which to train a classifier and we will
endeavor to add it to the list.</p>

<h2 id="the-insect-learning-and-classification-algorithms">The INSECT learning and classification algorithms</h2>

<p>To learn a classification tree, a reference sequence dataset is first
obtained from GenBank and/or other sources from which barcode sequences
with accurate taxon IDs are available. These sequences are filtered to
remove any with obvious taxonomic labeling issues, and trimmed to retain
only the region of interest using the <code>virtualPCR</code> function (sequences
that do not span the entire amplicon region are removed). the <code>learn</code>
function then splits the training sequences into two subsets, maximizing
the dissimilarity between the two groups. A profile hidden Markov model
is then derived for each group (see Durbin et al. (1998) for a detailed
description of these models). The partitioning and model training
procedure then continues recursively, splitting the reference sequences
into smaller and smaller subsets while adding new nodes and models to
the classification tree.</p>

<p>Once the classifier has been trained, query sequences obtained from the
specified primer set can be assigned taxonomic IDs along with
probabilistic confidence values. The classification algorithm works as
follows: starting from the root node of the classification tree, the
<em>likelihood</em> of the query sequence (the full probability of the sequence
given a particular model) is computed for each of the models at the two
immediate child nodes using the forward algorithm (see Durbin et al.
(1998)). The competing likelihood values are then compared by computing
their Akaike weights (see Johnson and Omland, 2004). If one model is
overwhelmingly more likely to have produced the sequence than the other,
that child node is selected and the classification is updated to reflect
the lowest common taxonomic rank of the training sequences belonging to
the node.</p>

<p>This procedure is repeated recursively, descending down the tree until
either an inconclusive result is returned from a model comparison test
(i.e. the Akaike weight is lower than a pre-defined threshold, e.g.
0.9), or a terminal leaf node is reached, at which point a species-level
ID is generally returned. The <code>classify</code> function outputs the taxon
name, rank and ID number (i.e. NCBI taxon ID, WoRMS aphia ID, or other
identifier depending on the taxonomy database used in the training
step), along with the final Akaike weight value, which can be
interpreted as a confidence score (between 0 and 1, with values close to
1 indicating high confidence). Note that the default behavior is for the
Akaike weight to &lsquo;decay&rsquo; as it moves down the tree, by computing the
cumulative product of all preceding Akaike weight values. This is
perhaps an overly conservative approach, but it minimizes the chance of
mis-classifying or over-classifying the query sequences.</p>

<h2 id="a-worked-example">A worked example</h2>

<p>This tutorial demonstrates the <strong>insect</strong> work-flow using an example
dataset of COI sequences derived from autonomous reef monitoring
structures (ARMS) in Ofu, American Samoa, amplified using the metazoan
COI barcoding primers mlCOIintF and jgHCO2198
(GGWACWGGWTGAACWGTWTAYCCYCC and TAIACYTCIGGRTGICCRAARAAYCA,
respectively; Leray et al. (2013)).</p>

<p>The dataset was first de-noised and tabulated using the
<a href="https://benjjneb.github.io/dada2/tutorial.html" target="_blank">DADA2</a> pipeline, to
produce a table of chimera-free amplicon sequence variants (ASVs). The
most abundant 16 ASVs are included in the <strong>insect</strong> package as an
example dataset (see below).</p>

<p>If using other tools for de-noising, trimming, merging, etc, the data
can be read in using either the <code>readFASTA</code> or <code>readFASTQ</code> functions to
produce a &ldquo;DNAbin&rdquo; object compatible with the <strong>insect</strong> classifier.</p>

<h3 id="loading-the-package-and-data">Loading the package and data</h3>

<p>First, make sure that the <strong>devtools</strong>, <strong>ape</strong> and <strong>seqinr</strong> packages
are installed and up to date. Then install and load the latest
development version of the <strong>insect</strong> package from GitHub as follows:</p>

<pre><code>devtools::install_github(&quot;shaunpwilkinson/insect&quot;)
library(insect)
</code></pre>

<p>The COI classifier was trained on the <a href="http://reference-midori.info/download.php" target="_blank">MIDORI UNIQUE
20180221</a> dataset, and uses
information from both the DNA read and the translated amino acid
sequence (<a href="https://www.ebi.ac.uk/ena/browse/translation-tables" target="_blank">EBI5</a>
invertebrate mitochondrial translation table) to assign taxonomy to
query sequences. You can download the classifier from the link in the
table above; the file is quite large (~ 140 MB), so make sure there is a
good internet connection available.</p>

<p>Alternatively, the classifier can be downloaded to the current working
directory as follows:</p>

<pre><code>download.file(&quot;https://www.dropbox.com/s/dvnrhnfmo727774/classifier.rds?dl=1&quot;, 
              destfile = &quot;classifier.rds&quot;, mode = &quot;wb&quot;)
</code></pre>

<h3 id="classifying-sequences">Classifying sequences</h3>

<p>To assign taxon IDs to the table of amplicon sequence variants (ASVs)
produced by DADA2, we first extract the sequences stored as column names
in the <code>seqtab.nochim</code> matrix (see the <a href="https://benjjneb.github.io/dada2/tutorial.html" target="_blank">DADA2
tutorial</a> for
instructions on how to produce this table).</p>

<p>Once the sequences are stored in memory as a &ldquo;DNAbin&rdquo; object, we can
optionally nullify the column names in the table to avoid flooding the
console with long sequence strings:</p>

<pre><code>## read in the example seqtab.nochim ASV table
data(samoa)
## get sequences from table column names
x &lt;- char2dna(colnames(samoa))
## name the sequences sequentially
names(x) &lt;- paste0(&quot;ASV&quot;, seq_along(x))
## optionally remove column names that can flood the console when printed
colnames(samoa) &lt;- NULL 
</code></pre>

<p>The next step is to load the classifier. Note that this &lsquo;insect&rsquo; class
object is just a large dendrogram with additional attributes for
classifying sequences including profile HMMs and taxonomic information:</p>

<!-- Prior to training the classifier, the sequences were trimmed to only 
include the amplicon produced by the mlCOIintF/jgHCO2198 primers, 
and further quality filtered to include only
sequences translating to functional proteins by aligning each sequence to 
a COI profile hidden Markov model using the **aphid** R package 
(https://CRAN.R-project.org/package=aphid). -->

<pre><code>classifier &lt;- readRDS(&quot;classifier.rds&quot;)
classifier
names(attributes(classifier))

#&gt; 'dendrogram' with 2 branches and 113833 members total, at height 70
#&gt;  [1] &quot;k&quot;           &quot;height&quot;      &quot;midpoint&quot;    &quot;members&quot;     &quot;class&quot;      
#&gt;  [6] &quot;taxonomy&quot;    &quot;clade&quot;       &quot;frame&quot;       &quot;remainder&quot;   &quot;sequences&quot;  
#&gt; [11] &quot;minscore&quot;    &quot;seqlengths&quot;  &quot;pointers&quot;    &quot;key&quot;         &quot;kmers&quot;      
#&gt; [16] &quot;minlength&quot;   &quot;maxlength&quot;   &quot;model&quot;       &quot;trainingset&quot; &quot;alternative&quot;
#&gt; [21] &quot;nunique&quot;     &quot;ntotal&quot;      &quot;taxID&quot;       &quot;numcode&quot;
</code></pre>

<p>The final step is to assign taxon IDs and confidence values to each ASV.
The <code>classify</code> function may take a minute or so to process these
sequences, since it uses a computationally intensive dynamic programming
algorithm to find the likelihood values of each sequence given the
models at each node of the tree. The exception is when <code>ping</code> is not
<code>FALSE</code> and there is an exact match or high similarity<br />
between the query sequence and at least one of the sequences in the
training dataset (e.g. &gt;= 99% if <code>ping = 0.99</code>). In this case the
function simply returns the common ancestor of the matching sequences
without a confidence score. To stay on the safe side, we will keep
<code>ping = 1</code> (i.e. only sequences with 100% identity are considered
matches).</p>

<p>The <code>classify</code> function can also be run in parallel by setting the
<code>cores</code> argument to 2 or more depending on the number available (setting
<code>cores = &quot;autodetect&quot;</code> will automatically run on one less than the
number available). If choosing this option for the large COI classifier,
please ensure that there is at least 2 GB of available RAM per
processor. Classification times can vary, and depend on several factors
including the number of unique sequences in the dataset, the size of the
classifier, the length of the input sequences, the processing speed,
number of processors used, etc. The average time to ID COI sequences
using the classifier above is approximately 3 - 4 seconds per unique
sequence per processor. For example, a dataset containing 1000 unique
sequences would take around an hour to process on a single processor,
half an hour on two, and so on.</p>

<p>In the following code we set <code>tabulize = FALSE</code> (the default setting)
since the DADA2 output table already contains the sequence counts and we
are only classifying the unique sequence variants. In the case where a
list of sequences containing replicates is to be processed, users can
prefix the sequence names with their respective sample names, delimited
with an underscore (e.g. &ldquo;sample001_sequence001&rdquo;) and set
<code>tabulize = TRUE</code>. In this case, the <code>classify</code> function will
automatically count and dereplicate the sequences, producing an output
table with one column of sequence counts for each sample.</p>

<pre><code>longDF &lt;- classify(x, classifier, threshold = 0.8)
</code></pre>

<p>For DADA2 users, the ASV abundance table can now be transposed and
appended to the table of taxonomic information if required:</p>

<pre><code>longDF &lt;- cbind(longDF, t(samoa))
</code></pre>

<!-- note newlines needed between html tags and code chunk -->

<table>
<thead>
<tr class="header">
<th align="left">representative</th>
<th align="right">taxID</th>
<th align="left">taxon</th>
<th align="left">rank</th>
<th align="right">score</th>
<th align="left">kingdom</th>
<th align="left">phylum</th>
<th align="left">class</th>
<th align="left">order</th>
<th align="left">family</th>
<th align="left">genus</th>
<th align="left">species</th>
<th align="right">OFU04A-100_S64</th>
<th align="right">OFU04A-1_S13</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">ASV1</td>
<td align="right">2806</td>
<td align="left">Florideophyceae</td>
<td align="left">class</td>
<td align="right">0.9981</td>
<td align="left"></td>
<td align="left"></td>
<td align="left">Florideophyceae</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right">156</td>
<td align="right">5600</td>
</tr>
<tr class="even">
<td align="left">ASV2</td>
<td align="right">6379</td>
<td align="left">Chaetopterus</td>
<td align="left">genus</td>
<td align="right">1.0000</td>
<td align="left">Metazoa</td>
<td align="left">Annelida</td>
<td align="left">Polychaeta</td>
<td align="left">Spionida</td>
<td align="left">Chaetopteridae</td>
<td align="left">Chaetopterus</td>
<td align="left"></td>
<td align="right">4496</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">ASV3</td>
<td align="right">2806</td>
<td align="left">Florideophyceae</td>
<td align="left">class</td>
<td align="right">0.9989</td>
<td align="left"></td>
<td align="left"></td>
<td align="left">Florideophyceae</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right">28</td>
<td align="right">3267</td>
</tr>
<tr class="even">
<td align="left">ASV4</td>
<td align="right">2172821</td>
<td align="left">Multicrustacea</td>
<td align="left">superclass</td>
<td align="right">1.0000</td>
<td align="left">Metazoa</td>
<td align="left">Arthropoda</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right">3203</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">ASV5</td>
<td align="right">131567</td>
<td align="left">cellular organisms</td>
<td align="left">no rank</td>
<td align="right">0.9952</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right">3024</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">ASV6</td>
<td align="right">2806</td>
<td align="left">Florideophyceae</td>
<td align="left">class</td>
<td align="right">0.9981</td>
<td align="left"></td>
<td align="left"></td>
<td align="left">Florideophyceae</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right">20</td>
<td align="right">2409</td>
</tr>
<tr class="odd">
<td align="left">ASV7</td>
<td align="right">39820</td>
<td align="left">Nereididae</td>
<td align="left">family</td>
<td align="right">1.0000</td>
<td align="left">Metazoa</td>
<td align="left">Annelida</td>
<td align="left">Polychaeta</td>
<td align="left">Phyllodocida</td>
<td align="left">Nereididae</td>
<td align="left"></td>
<td align="left"></td>
<td align="right">2379</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">ASV8</td>
<td align="right">116571</td>
<td align="left">Podoplea</td>
<td align="left">superorder</td>
<td align="right">0.9995</td>
<td align="left">Metazoa</td>
<td align="left">Arthropoda</td>
<td align="left">Hexanauplia</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right">2156</td>
<td align="right">104</td>
</tr>
<tr class="odd">
<td align="left">ASV9</td>
<td align="right">2806</td>
<td align="left">Florideophyceae</td>
<td align="left">class</td>
<td align="right">0.9482</td>
<td align="left"></td>
<td align="left"></td>
<td align="left">Florideophyceae</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right">0</td>
<td align="right">2149</td>
</tr>
<tr class="even">
<td align="left">ASV10</td>
<td align="right">1</td>
<td align="left">root</td>
<td align="left">no rank</td>
<td align="right">NA</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right">2091</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">ASV11</td>
<td align="right">115834</td>
<td align="left">Hesionidae</td>
<td align="left">family</td>
<td align="right">1.0000</td>
<td align="left">Metazoa</td>
<td align="left">Annelida</td>
<td align="left">Polychaeta</td>
<td align="left">Phyllodocida</td>
<td align="left">Hesionidae</td>
<td align="left"></td>
<td align="left"></td>
<td align="right">1905</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="left">ASV12</td>
<td align="right">1443949</td>
<td align="left">Corallinophycidae</td>
<td align="left">subclass</td>
<td align="right">0.9910</td>
<td align="left"></td>
<td align="left"></td>
<td align="left">Florideophyceae</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right">87</td>
<td align="right">1757</td>
</tr>
<tr class="odd">
<td align="left">ASV13</td>
<td align="right">33213</td>
<td align="left">Bilateria</td>
<td align="left">no rank</td>
<td align="right">1.0000</td>
<td align="left">Metazoa</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right">27</td>
<td align="right">1800</td>
</tr>
<tr class="even">
<td align="left">ASV14</td>
<td align="right">131567</td>
<td align="left">cellular organisms</td>
<td align="left">no rank</td>
<td align="right">0.9952</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right">1729</td>
<td align="right">9</td>
</tr>
<tr class="odd">
<td align="left">ASV15</td>
<td align="right">2806</td>
<td align="left">Florideophyceae</td>
<td align="left">class</td>
<td align="right">0.9993</td>
<td align="left"></td>
<td align="left"></td>
<td align="left">Florideophyceae</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right">0</td>
<td align="right">1725</td>
</tr>
<tr class="even">
<td align="left">ASV16</td>
<td align="right">39820</td>
<td align="left">Nereididae</td>
<td align="left">family</td>
<td align="right">1.0000</td>
<td align="left">Metazoa</td>
<td align="left">Annelida</td>
<td align="left">Polychaeta</td>
<td align="left">Phyllodocida</td>
<td align="left">Nereididae</td>
<td align="left"></td>
<td align="left"></td>
<td align="right">1481</td>
<td align="right">0</td>
</tr>
</tbody>
</table>

<!--
The function produces a data frame with one row for each ASV
Assuming `ping` is not `FALSE`, query sequences that have 
exact or close matches in the training dataset 
(and hence bypass the recursive classification procedure)
are assigned a score of `NA`.
-->

<p>Any sequences that return exact hits with at least one training sequence
(or near matches if <code>ping = 0.99</code> or similar) are assigned a score of
<code>NA</code>. For hybrid DNA/AA classifiers such as the COI version used above,
non-translatable sequences are also automatically assigned a score of
<code>NA</code>, as is the case for ASV10 in the table above.</p>

<p>For a more succinct output we can aggregate the table to only include
one row for each unique taxon as follows:</p>

<pre><code>taxa &lt;- aggregate(longDF[3:12], longDF[&quot;taxID&quot;], head, 1)
counts &lt;- aggregate(longDF[13:ncol(longDF)], longDF[&quot;taxID&quot;], sum)
shortDF &lt;- merge(taxa, counts, by = &quot;taxID&quot;)
</code></pre>

<!-- note newlines needed between html tags and code chunk -->

<table>
<thead>
<tr class="header">
<th align="right">taxID</th>
<th align="left">taxon</th>
<th align="left">rank</th>
<th align="right">score</th>
<th align="left">kingdom</th>
<th align="left">phylum</th>
<th align="left">class</th>
<th align="left">order</th>
<th align="left">family</th>
<th align="left">genus</th>
<th align="left">species</th>
<th align="right">OFU04A-100_S64</th>
<th align="right">OFU04A-1_S13</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left">root</td>
<td align="left">no rank</td>
<td align="right">NA</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right">2091</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">2806</td>
<td align="left">Florideophyceae</td>
<td align="left">class</td>
<td align="right">0.9981</td>
<td align="left"></td>
<td align="left"></td>
<td align="left">Florideophyceae</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right">204</td>
<td align="right">15150</td>
</tr>
<tr class="odd">
<td align="right">6379</td>
<td align="left">Chaetopterus</td>
<td align="left">genus</td>
<td align="right">1.0000</td>
<td align="left">Metazoa</td>
<td align="left">Annelida</td>
<td align="left">Polychaeta</td>
<td align="left">Spionida</td>
<td align="left">Chaetopteridae</td>
<td align="left">Chaetopterus</td>
<td align="left"></td>
<td align="right">4496</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">33213</td>
<td align="left">Bilateria</td>
<td align="left">no rank</td>
<td align="right">1.0000</td>
<td align="left">Metazoa</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right">27</td>
<td align="right">1800</td>
</tr>
<tr class="odd">
<td align="right">39820</td>
<td align="left">Nereididae</td>
<td align="left">family</td>
<td align="right">1.0000</td>
<td align="left">Metazoa</td>
<td align="left">Annelida</td>
<td align="left">Polychaeta</td>
<td align="left">Phyllodocida</td>
<td align="left">Nereididae</td>
<td align="left"></td>
<td align="left"></td>
<td align="right">3860</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">115834</td>
<td align="left">Hesionidae</td>
<td align="left">family</td>
<td align="right">1.0000</td>
<td align="left">Metazoa</td>
<td align="left">Annelida</td>
<td align="left">Polychaeta</td>
<td align="left">Phyllodocida</td>
<td align="left">Hesionidae</td>
<td align="left"></td>
<td align="left"></td>
<td align="right">1905</td>
<td align="right">6</td>
</tr>
<tr class="odd">
<td align="right">116571</td>
<td align="left">Podoplea</td>
<td align="left">superorder</td>
<td align="right">0.9995</td>
<td align="left">Metazoa</td>
<td align="left">Arthropoda</td>
<td align="left">Hexanauplia</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right">2156</td>
<td align="right">104</td>
</tr>
<tr class="even">
<td align="right">131567</td>
<td align="left">cellular organisms</td>
<td align="left">no rank</td>
<td align="right">0.9952</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right">4753</td>
<td align="right">9</td>
</tr>
<tr class="odd">
<td align="right">1443949</td>
<td align="left">Corallinophycidae</td>
<td align="left">subclass</td>
<td align="right">0.9910</td>
<td align="left"></td>
<td align="left"></td>
<td align="left">Florideophyceae</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right">87</td>
<td align="right">1757</td>
</tr>
<tr class="even">
<td align="right">2172821</td>
<td align="left">Multicrustacea</td>
<td align="left">superclass</td>
<td align="right">1.0000</td>
<td align="left">Metazoa</td>
<td align="left">Arthropoda</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="right">3203</td>
<td align="right">0</td>
</tr>
</tbody>
</table>

<p>As shown in the above example, many of the sequences return fairly
uninformative taxon IDs (e.g. &lsquo;cellular organisms&rsquo;). This is a fairly
typical feature of eDNA datasets that can contain a large number of
novel sequences that are dissimilar to anything recorded in the
reference database(s). Note that query sequences with high similarity to
reference sequences can also occasionally produce uninformative
classifications due to inconclusive model comparison tests at top-level
nodes. This may be circumvented by reducing the <code>threshold</code> parameter or
setting <code>decay = FALSE</code>; however, users are advised against the
excessive relaxation of these parameters since it may increase the
chance of returning erroneous classifications (these tend to be very
rare when using the default values). Further testing and optimization
may help to address some of these best-practice considerations, and will
be a focus of future research.</p>

<p>This introduction to the <strong>insect</strong> package has outlined the steps
involved in taxonomic identification of amplicon sequence variants
(ASVs) using a pre-built classification tree. The next tutorial will
deal with downloading and curating a primer-specific local sequence
database and using it to build a classification tree.</p>

<p>Please feel free to email the author directly with any feedback or
questions at shaunpwilkinson AT gmail DOT com. Bug reports can also be
directed to the <a href="http://github.com/shaunpwilkinson/insect/issues" target="_blank">GitHub issues
page</a>.</p>

<h2 id="acknowledgements">Acknowledgements</h2>

<p>This software was developed with funding from a Rutherford Foundation
Postdoctoral Research Fellowship from the Royal Society of New Zealand.
Unpublished COI data care of Molly Timmers (NOAA).</p>

<h2 id="references">References</h2>

<p>Callahan,B.J. <em>et al.</em> (2016) DADA2: High-resolution sample inference
from illumina amplicon data. <em>Nature Methods</em>, <strong>13</strong>, 581–583.</p>

<p>Durbin,R. <em>et al.</em> (1998) Biological Sequence Analysis: Probabilistic
Models of Proteins and Nucleic Acids. Cambridge University Press,
Cambridge.</p>

<p>Johnson,J.B. and Omland,K.S. (2004) Model selection in ecology and
evolution. <em>Trends in Ecology and Evolution</em>, <strong>19</strong>, 101–108.</p>

<p>Leray,M. <em>et al.</em> (2013) A new versatile primer set targeting a short
fragment of the mitochondrial COI region for metabarcoding metazoan
diversity: application for characterizing coral reef fish gut contents.
<em>Frontiers in Zoology</em>, <strong>10</strong>, 34.</p>

<p>Paradis,E. (2012) Analysis of Phylogenetics and Evolution with R. Second
Edition. Springer, New York.</p>

<p>Paradis,E. <em>et al.</em> (2004) APE: analyses of phylogenetics and evolution
in R language. <em>Bioinformatics</em>, <strong>20</strong>, 289–290.</p>

    </div>
  </div>

</article>

<div class="container">
  <nav>
  <ul class="pager">
    
    <li class="previous"><a href="/post/aphid-vignette/"><span
      aria-hidden="true">&larr;</span> The &#39;aphid&#39; package for analysis with profile hidden Markov models</a></li>
    

    
  </ul>
</nav>

</div>

<div class="article-container">
  
<section id="comments">
  <div id="disqus_thread">
    <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "shaunpwilkinson" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</section>


</div>

<footer class="site-footer">
  <div class="container">
    <p class="powered-by">

      &copy; 2019 Shaun Wilkinson &middot; 

      Powered by the <a href="https://github.com/gcushen/hugo-academic" target="_blank">Academic
      theme</a> for <a href="http://gohugo.io" target="_blank">Hugo</a>.

      <span class="pull-right" aria-hidden="true">
        <a href="#" id="back_to_top">
          <span class="button_icon">
            <i class="fa fa-chevron-up fa-2x"></i>
          </span>
        </a>
      </span>

    </p>
  </div>
</footer>

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js" integrity="sha512-jGsMH83oKe9asCpkOVkBnUrDDTp8wl+adkB2D+//JtlxO4SrLoJdhbOysIFQJloQFD+C4Fl1rMsQZF76JjV0eQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.2/imagesloaded.pkgd.min.js" integrity="sha512-iHzEu7GbSc705hE2skyH6/AlTpOfBmkx7nUqTLGzPYR+C1tRaItbRlJ7hT/D3YQ9SV0fqLKzp4XY9wKulTBGTw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.19.1/TweenMax.min.js" integrity="sha512-Z5heTz36xTemt1TbtbfXtTq5lMfYnOkXM2/eWcTTiLU01+Sw4ku1i7vScDc8fWhrP2abz9GQzgKH5NGBLoYlAw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.19.1/plugins/ScrollToPlugin.min.js" integrity="sha512-CDeU7pRtkPX6XJtF/gcFWlEwyaX7mcAp5sO3VIu/ylsdR74wEw4wmBpD5yYTrmMAiAboi9thyBUr1vXRPA7t0Q==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha512-iztkobsvnjKfAtTNdHkGVjAYTrrtlC7mGp/54c40wowO7LhURYl3gVzzcEqGl/qKXQltJ2HwMrdLcNUdo+N/RQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js" integrity="sha512-VDBOIlDbuC4VWxGJNmuFRQ0Li0SKkDpmGyuhAG5LTDLd/dJ/S0WMVxriR2Y+CyPL5gzjpN4f/6iqWVBJlht0tQ==" crossorigin="anonymous"></script>
    
    <script src="/js/hugo-academic.js"></script>
    

    
    
      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>

      

      

      <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML" integrity="sha512-tOav5w1OjvsSJzePRtt2uQPFwBoHt1VZcUq8l8nm5284LEKE9FSJBQryzMBzHxY5P0zRdNqEcpLIRVYFNgu1jw==" crossorigin="anonymous"></script>
    
    

  </body>
</html>

